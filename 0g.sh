#!/bin/bash

# –õ–æ–≥–æ—Ç–∏–ø
echo -e '\e[40m\e[32m'
echo -e '‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó '
echo -e '‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó'
echo -e '‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù'
echo -e '‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó'
echo -e '‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë'
echo -e '‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù'
echo -e '\e[0m'

echo -e "\n–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª may.crypto{ü¶Ö} —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ —Å–∞–º—ã—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–¥ - https://t.me/maycrypto\n"

menu() {
  echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
  echo "1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É 0G Labs"
  echo "2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é 0G Labs"
  echo "3. –°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª–µ–∫ 0G Labs"
  echo "4. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ—à–µ–ª–µ–∫ 0G Labs"
  echo "5. –°–æ–∑–¥–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ 0G Labs"
  echo "6. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –Ω–æ–¥—ã 0G Labs"
  echo "7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞"
  echo "8. –í—ã–π—Ç–∏ –∏–∑ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞"
  read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è: " action

  case $action in
    1)
      install_node
      ;;
    2)
      check_sync
      ;;
    3)
      create_wallet
      ;;
    4)
      import_wallet
      ;;
    5)
      create_validator
      ;;
    6)
      view_logs
      ;;
    7)
      check_balance
      ;;
    8)
      exit 0
      ;;
    *)
      echo "–ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
      menu
      ;;
  esac
}

install_node() {
  read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ—à–µ–ª—å–∫–∞: " WALLET
  echo 'export WALLET='$WALLET
  read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à MONIKER: " MONIKER
  echo 'export MONIKER='$MONIKER
  read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à PORT (–Ω–∞–ø—Ä–∏–º–µ—Ä, 17, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 26): " PORT
  echo 'export PORT='$PORT

  echo "export WALLET=$WALLET" >> $HOME/.bash_profile
  echo "export MONIKER=$MONIKER" >> $HOME/.bash_profile
  echo "export OG_CHAIN_ID=zgtendermint_16600-2" >> $HOME/.bash_profile
  echo "export OG_PORT=$PORT" >> $HOME/.bash_profile
  echo "export PATH=$PATH:/usr/local/go/bin:~/go/bin:$(go env GOPATH)/bin" >> $HOME/.bash_profile
  source $HOME/.bash_profile

  printLine
  echo -e "Moniker:        \e[1m\e[32m$MONIKER\e[0m"
  echo -e "Wallet:         \e[1m\e[32m$WALLET\e[0m"
  echo -e "Chain id:       \e[1m\e[32m$OG_CHAIN_ID\e[0m"
  echo -e "Node custom port:  \e[1m\e[32m$OG_PORT\e[0m"
  printLine
  sleep 1

  printGreen "1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ go..." && sleep 1
  cd $HOME
  VER="1.21.3"
  wget "https://golang.org/dl/go$VER.linux-amd64.tar.gz"
  sudo rm -rf /usr/local/go
  sudo tar -C /usr/local -xzf "go$VER.linux-amd64.tar.gz"
  rm "go$VER.linux-amd64.tar.gz"
  [ ! -f ~/.bash_profile ] && touch ~/.bash_profile
  echo "export PATH=$PATH:/usr/local/go/bin:~/go/bin" >> ~/.bash_profile
  source $HOME/.bash_profile
  [ ! -d ~/go/bin ] && mkdir -p ~/go/bin

  echo $(go version) && sleep 1

  source <(curl -s https://raw.githubusercontent.com/itrocket-team/testnet_guides/main/utils/dependencies_install)

  printGreen "4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..." && sleep 1
  cd $HOME
  rm -rf 0g-chain
  git clone -b v0.2.3 https://github.com/0glabs/0g-chain.git
  cd 0g-chain
  make install

  printGreen "5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..." && sleep 1
  0gchaind config node tcp://localhost:${OG_PORT}657
  0gchaind config keyring-backend os
  0gchaind config chain-id zgtendermint_16600-2
  0gchaind init $MONIKER --chain-id zgtendermint_16600-2
  sleep 1
  echo done

  printGreen "6. –ó–∞–≥—Ä—É–∑–∫–∞ –≥–µ–Ω–µ–∑–∏—Å–∞ –∏ addrbook..." && sleep 1
  wget -O $HOME/.0gchain/config/genesis.json https://testnet-files.itrocket.net/og/genesis.json
  wget -O $HOME/.0gchain/config/addrbook.json https://testnet-files.itrocket.net/og/addrbook.json
  sleep 1
  echo done

  printGreen "7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ seeds, peers, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤, pruning, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –≥–∞–∑–∞..." && sleep 1
  SEEDS="8f21742ea5487da6e0697ba7d7b36961d3599567@og-testnet-seed.itrocket.net:47656"
  PEERS="c76473c97fa718d1c4c48910c17318883300a36b@og-testnet-peer.itrocket.net:11656"
  sed -i -e "s/^seeds *=.*/seeds = \"$SEEDS\"/; s/^persistent_peers *=.*/persistent_peers = \"$PEERS\"/" $HOME/.0gchain/config/config.toml

  sed -i.bak -e "s%:1317%:${OG_PORT}317%g;
  s%:8080%:${OG_PORT}080%g;
  s%:9090%:${OG_PORT}090%g;
  s%:9091%:${OG_PORT}091%g;
  s%:8545%:${OG_PORT}545%g;
  s%:8546%:${OG_PORT}546%g;
  s%:6065%:${OG_PORT}065%g" $HOME/.0gchain/config/app.toml

  sed -i.bak -e "s%:26658%:${OG_PORT}658%g;
  s%:26657%:${OG_PORT}657%g;
  s%:6060%:${OG_PORT}060%g;
  s%:26656%:${OG_PORT}656%g;
  s%^external_address = \"\"%external_address = \"$(wget -qO- eth0.me):${OG_PORT}656\"%;
  s%:26660%:${OG_PORT}660%g" $HOME/.0gchain/config/config.toml

  sed -i -e "s/^pruning *=.*/pruning = \"custom\"/" $HOME/.0gchain/config/app.toml
  sed -i -e "s/^pruning-keep-recent *=.*/pruning-keep-recent = \"100\"/" $HOME/.0gchain/config/app.toml
  sed -i -e "s/^pruning-interval *=.*/pruning-interval = \"50\"/" $HOME/.0gchain/config/app.toml

  sed -i 's|minimum-gas-prices =.*|minimum-gas-prices = "0ua0gi"|g' $HOME/.0gchain/config/app.toml
  sed -i -e "s/prometheus = false/prometheus = true/" $HOME/.0gchain/config/config.toml
  sed -i -e "s/^indexer *=.*/indexer = \"null\"/" $HOME/.0gchain/config/config.toml
  sleep 1
  echo done

  sudo tee /etc/systemd/system/0gchaind.service > /dev/null <<EOF
[Unit]
Description=og node
After=network-online.target
[Service]
User=$USER
WorkingDirectory=$HOME/.0gchain
ExecStart=$(which 0gchaind) start --home $HOME/.0gchain
Restart=on-failure
RestartSec=5
LimitNOFILE=65535
[Install]
WantedBy=multi-user.target
EOF

  printGreen "8. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–µ–ø—à–æ—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ –Ω–æ–¥—ã..." && sleep 1
  0gchaind tendermint unsafe-reset-all --home $HOME/.0gchain
  if curl -s --head curl https://testnet-files.itrocket.net/og/snap_og.tar.lz4 | head -n 1 | grep "200" > /dev/null; then
    curl https://testnet-files.itrocket.net/og/snap_og.tar.lz4 | lz4 -dc - | tar -xf - -C $HOME/.0gchain
  else
    echo –Ω–µ—Ç —Å–Ω–µ–ø—à–æ—Ç–∞
  fi

  sudo systemctl daemon-reload
  sudo systemctl enable 0gchaind
  sudo systemctl restart 0gchaind
  echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–µ–Ω—é..."
  menu
}

check_sync() {
  0gchaind status 2>&1 | jq
  echo "–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–µ–Ω—é..."
  menu
}

create_wallet() {
  read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ—à–µ–ª—å–∫–∞: " WALLET
  0gchaind keys add $WALLET

  WALLET_ADDRESS=$(0gchaind keys show $WALLET -a)
  VALOPER_ADDRESS=$(0gchaind keys show $WALLET --bech val -a)
  echo "export WALLET_ADDRESS=$WALLET_ADDRESS" >> $HOME/.bash_profile
  echo "export VALOPER_ADDRESS=$VALOPER_ADDRESS" >> $HOME/.bash_profile
  source $HOME/.bash_profile

  0gchaind debug addr $(0gchaind keys show $WALLET_ADDRESS -a) | grep 'Address (hex):' | awk -F ': ' '{print "0x" $2}'

  echo "–ö–æ—à–µ–ª–µ–∫ —Å–æ–∑–¥–∞–Ω. –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–µ–Ω—é..."
  menu
}

import_wallet() {
  read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ—à–µ–ª—å–∫–∞: " WALLET
  0gchaind keys add $WALLET --recover

  WALLET_ADDRESS=$(0gchaind keys show $WALLET -a)
  VALOPER_ADDRESS=$(0gchaind keys show $WALLET --bech val -a)
  echo "export WALLET_ADDRESS=$WALLET_ADDRESS" >> $HOME/.bash_profile
  echo "export VALOPER_ADDRESS=$VALOPER_ADDRESS" >> $HOME/.bash_profile
  source $HOME/.bash_profile

  0gchaind debug addr $(0gchaind keys show $WALLET_ADDRESS -a) | grep 'Address (hex):' | awk -F ': ' '{print "0x" $2}'

  echo "–ö–æ—à–µ–ª–µ–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω. –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–µ–Ω—é..."
  menu
}

create_validator() {
  read -p "–†–∞–Ω–µ–µ –í—ã —É–∂–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ 0G Labs? [–¥–∞/–Ω–µ—Ç]: " response
  if [[ "$response" == "–¥–∞" || "$response" == "–î–∞" ]]; then
    0gchaind tx staking edit-validator \
    --commission-rate 0.1 \
    --new-moniker "$MONIKER" \
    --identity "" \
    --details "" \
    --from $WALLET \
    --chain-id zgtendermint_16600-2 \
    --gas=auto --gas-adjustment=1.6 \
    -y
  else
    0gchaind tx staking create-validator \
    --amount 1000000ua0gi \
    --from $WALLET \
    --commission-rate 0.1 \
    --commission-max-rate 0.2 \
    --commission-max-change-rate 0.01 \
    --min-self-delegation 1 \
    --pubkey $(0gchaind tendermint show-validator) \
    --moniker "$MONIKER" \
    --identity "" \
    --details "" \
    --chain-id zgtendermint_16600-2 \
    --gas=auto --gas-adjustment=1.6 \
    -y
  fi

  echo "–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–µ–Ω—é..."
  menu
}

view_logs() {
  echo "–ß–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥ –Ω–∞—á–Ω–µ—Ç—Å—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –Ω–æ–¥—ã 0G Labs. –î–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –≤ –º–µ–Ω—é –Ω–∞–∂–º–∏—Ç–µ CTRL+C"
  sleep 15
  sudo journalctl -u 0gchaind -f
}

check_balance() {
  0gchaind q bank balances $WALLET_ADDRESS
  echo "–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–µ–Ω—é..."
  menu
}

menu
